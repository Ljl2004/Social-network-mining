# 中文字体自动检测说明

## 更新内容

### ✅ 已修复的问题

1. **中文乱码问题** - 系统现在会自动检测并使用本机可用的中文字体
2. **子图标签重叠** - 增大图表尺寸和调整布局间距，避免标签互相覆盖

---

## 自动字体检测

系统会按优先级自动检测以下中文字体：

### macOS 系统
1. **PingFang SC** - macOS 默认中文字体（简体中文）
2. **Hiragino Sans GB** - macOS 冬青黑体（简体中文）
3. **STHeiti** - 华文黑体

### Windows 系统
1. **Microsoft YaHei** - 微软雅黑
2. **SimHei** - 黑体
3. **SimSun** - 宋体

### Linux 系统
1. **WenQuanYi Micro Hei** - 文泉驿微米黑
2. **Noto Sans CJK SC** - Noto 简体中文字体

### 通用字体
- **Arial Unicode MS** - Unicode 通用字体

---

## 检测机制

```python
def get_chinese_font():
    """自动查找系统中可用的中文字体"""
    # 常见中文字体列表（按优先级排序）
    chinese_fonts = [
        'PingFang SC',           # macOS
        'Hiragino Sans GB',      # macOS
        'STHeiti',               # macOS
        'Microsoft YaHei',       # Windows
        'SimHei',                # Windows
        'SimSun',                # Windows
        'WenQuanYi Micro Hei',   # Linux
        'Noto Sans CJK SC',      # Linux
        'Arial Unicode MS',      # 通用
    ]
    
    # 获取系统所有可用字体
    available_fonts = [f.name for f in fm.fontManager.ttflist]
    
    # 查找第一个可用的中文字体
    for font in chinese_fonts:
        if font in available_fonts:
            return font
    
    return 'sans-serif'  # 默认字体
```

---

## 布局优化

### 调整前
- 图表尺寸: 15x10 / 14x10
- 布局间距: 默认（标签经常重叠）

### 调整后
- **时间模式图**: 16x12 (增大以容纳4个子图)
- **用户活跃度图**: 16x12 (增大以容纳4个子图)
- **布局间距**: `pad=3.0, h_pad=3.0, w_pad=3.0`
  - `pad`: 图表外围边距
  - `h_pad`: 子图之间垂直间距
  - `w_pad`: 子图之间水平间距

---

## 使用示例

### 查看检测到的字体

运行任何可视化程序时，会在控制台输出：

```
使用中文字体: Hiragino Sans GB
```

或

```
使用中文字体: Microsoft YaHei
```

如果没有找到推荐字体：

```
警告: 未找到推荐的中文字体，使用系统默认字体
```

---

## 测试验证

```bash
cd src

# 快速测试
python quick_example.py

# 完整演示
python demo.py

# 字号自定义演示
python demo_font_customization.py
```

运行后查看控制台输出，确认使用的字体。

---

## 查看本机可用中文字体

### 使用 Python 脚本查询

```python
import matplotlib.font_manager as fm

# 获取所有字体
fonts = [f.name for f in fm.fontManager.ttflist]

# 筛选中文字体（包含中文名称或CJK相关的字体）
chinese_keywords = ['SC', 'GB', 'Hei', 'Song', 'YaHei', 'SimHei', 
                    'SimSun', 'PingFang', 'Hiragino', 'STHeiti',
                    'WenQuanYi', 'Noto', 'CJK']

chinese_fonts = [f for f in fonts 
                if any(keyword in f for keyword in chinese_keywords)]

print("本机可用中文字体:")
for font in sorted(set(chinese_fonts)):
    print(f"  - {font}")
```

### macOS 系统命令

```bash
# 查看所有字体
fc-list :lang=zh

# 或使用系统字体册
open /Applications/Font\ Book.app
```

---

## 常见问题

### Q: 如何手动指定字体？

A: 修改 `visualizer.py` 中的字体列表，将你想用的字体放在最前面：

```python
chinese_fonts = [
    'Your Preferred Font',   # 你的首选字体
    'PingFang SC',
    # ... 其他字体
]
```

### Q: 为什么还是显示乱码？

A: 可能原因：
1. 系统没有安装任何中文字体
2. matplotlib 缓存问题

解决方法：

```bash
# 清除 matplotlib 缓存
rm -rf ~/.matplotlib

# 重新运行程序
python demo.py
```

### Q: 如何安装新的中文字体？

A: 
- **macOS**: 双击字体文件 → 安装字体
- **Windows**: 右键字体文件 → 安装
- **Linux**: 
  ```bash
  sudo apt-get install fonts-noto-cjk  # Ubuntu/Debian
  sudo yum install wqy-microhei-fonts  # CentOS/RHEL
  ```

### Q: 子图标签还是重叠怎么办？

A: 可以进一步增大图表尺寸或间距：

```python
# 在 visualizer.py 中修改
fig, axes = plt.subplots(2, 2, figsize=(18, 14))  # 更大尺寸
plt.tight_layout(pad=4.0, h_pad=4.0, w_pad=4.0)  # 更大间距
```

---

## 技术细节

### 字体优先级设计原则

1. **美观性**: 优先选择设计优秀的现代字体（如 PingFang SC）
2. **兼容性**: 包含各平台常见字体
3. **清晰度**: 选择在屏幕和打印上都清晰的字体
4. **通用性**: 最后回退到 Unicode 通用字体

### 布局参数说明

```python
plt.tight_layout(
    pad=3.0,    # 图表边缘到子图的距离
    h_pad=3.0,  # 子图之间的垂直间距（字体高度的倍数）
    w_pad=3.0   # 子图之间的水平间距（字体宽度的倍数）
)
```

---

## 对比效果

### 修复前
- ❌ 中文显示为方块或乱码
- ❌ 子图标题、标签互相重叠
- ❌ 图表拥挤，不易阅读

### 修复后
- ✅ 中文正常显示
- ✅ 标签间距合理，清晰可读
- ✅ 布局舒适，专业美观

---

**更新时间**: 2025年12月8日  
**版本**: v2.1
